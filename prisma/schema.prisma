datasource db {
    provider = "postgresql"
}

generator client {
    provider = "prisma-client-js"
}

// --- ENUMS ---

enum UserStatus {
    ACTIVE
    SUSPENDED
    PENDING_VERIFICATION
}

enum GrantType {
    AUTHORIZATION_CODE
    REFRESH_TOKEN
    CLIENT_CREDENTIALS // Quan trọng cho yêu cầu của bạn
    PASSWORD
}

enum ClientRole {
    SERVICE_ACCOUNT // Client dùng để chạy background/admin task
    THIRD_PARTY_APP // Client thông thường
}

// --- CORE IDENTITY (User) ---

model User {
    id          String  @id @default(uuid())
    email       String  @unique
    phoneNumber String? @unique

    // Password & Security
    password   PasswordCredential?
    passkeys   PasskeyCredential[]
    mfaMethods TwoFactorMethod[]

    status UserStatus @default(ACTIVE)

    // Audit: User này được tạo bởi Client nào? (Quan trọng theo yêu cầu của bạn)
    createdViaClientId String?
    createdViaClient   ClientApp? @relation("ClientCreatedUsers", fields: [createdViaClientId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    // Relations
    profile  UserProfile?
    consents UserConsent[]
    sessions AuthSession[]

    // Trong luồng Authorization Code (User login), User sở hữu tokens
    authCodes     AuthorizationCode[]
    refreshTokens RefreshToken[]

    @@map("users")
}

model UserProfile {
    id        String    @id @default(uuid())
    userId    String    @unique
    user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    fullName  String?
    avatarUrl String?
    birthDate DateTime?

    @@map("user_profiles")
}

// --- CLIENT APPLICATION (The Admin/Service) ---

model ClientApp {
    id           String  @id @default(uuid())
    clientId     String  @unique
    clientSecret String // Hash (Bcrypt/Argon2)
    appName      String
    description  String?

    // Role xác định Client này có quyền quản trị hay không
    role ClientRole @default(THIRD_PARTY_APP)

    // Cấu hình các quyền mặc định của Client (ví dụ: ["user:create", "system:read"])
    authorities String[]

    // Config OAuth
    redirectUris      String[]
    allowedGrantTypes GrantType[] // Cần chứa "CLIENT_CREDENTIALS"
    allowedScopes     Scope[]     @relation("ClientAllowedScopes")

    // Relations
    // Client này đã tạo ra những user nào?
    createdUsers User[] @relation("ClientCreatedUsers")

    // Tokens do Client này sở hữu (khi dùng Client Credentials flow)
    issuedRefreshTokens RefreshToken[]

    // OAuth relations khác
    consents  UserConsent[]
    authCodes AuthorizationCode[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@map("oauth_clients")
}

// --- CREDENTIALS & MFA (Giữ nguyên như cũ) ---
model PasswordCredential {
    id           String   @id @default(uuid())
    userId       String   @unique
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    passwordHash String
    updatedAt    DateTime @updatedAt

    @@map("user_passwords")
}

model PasskeyCredential {
    id           String   @id @default(uuid())
    userId       String
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    credentialId String   @unique
    publicKey    String   @db.Text
    signCount    Int      @default(0)
    transports   String[]
    createdAt    DateTime @default(now())

    @@map("user_passkeys")
}

model TwoFactorMethod {
    id        String   @id @default(uuid())
    userId    String
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    type      String // TOTP, SMS
    secret    String
    isDefault Boolean  @default(false)
    createdAt DateTime @default(now())

    @@map("user_mfa_methods")
}

// --- SCOPES ---
model Scope {
    id          String  @id @default(uuid())
    name        String  @unique // e.g., "user:create", "openid"
    description String?

    clients   ClientApp[]         @relation("ClientAllowedScopes")
    consents  UserConsent[]       @relation("ConsentScopes")
    authCodes AuthorizationCode[] @relation("AuthCodeScopes")

    @@map("oauth_scopes")
}

// --- TOKENS (Updated for M2M) ---

model RefreshToken {
    id    String @id @default(uuid())
    token String @unique

    clientId String
    client   ClientApp @relation(fields: [clientId], references: [id], onDelete: Cascade)

    // QUAN TRỌNG: userId có thể NULL
    // Nếu userId = null -> Token này là "App Token" (Client Credentials Flow)
    // Nếu userId != null -> Token này là "User Token" (Authorization Code Flow)
    userId String?
    user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

    scopes String[] // Snapshot các quyền của token này

    parentTokenId String?
    revoked       Boolean  @default(false)
    expiresAt     DateTime
    createdAt     DateTime @default(now())

    @@map("oauth_refresh_tokens")
}

model AuthorizationCode {
    id       String    @id @default(uuid())
    code     String    @unique
    clientId String
    client   ClientApp @relation(fields: [clientId], references: [id], onDelete: Cascade)
    userId   String
    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)

    // Session chỉ cần thiết cho User Login flow
    sessionId String?
    session   AuthSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

    scopes Scope[] @relation("AuthCodeScopes")

    codeChallenge String
    expiresAt     DateTime

    @@map("oauth_auth_codes")
}

// --- SESSIONS (Chỉ dùng cho User login) ---
model UserConsent {
    id            String    @id @default(uuid())
    userId        String
    user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    clientId      String
    client        ClientApp @relation(fields: [clientId], references: [id], onDelete: Cascade)
    grantedScopes Scope[]   @relation("ConsentScopes")

    @@unique([userId, clientId])
    @@map("oauth_consents")
}

model AuthSession {
    id             String              @id @default(uuid())
    userId         String
    user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)
    isMfaCompleted Boolean             @default(false)
    expiresAt      DateTime
    authCodes      AuthorizationCode[]

    @@map("auth_sessions")
}
